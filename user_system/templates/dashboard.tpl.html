<!-- ç”¨æˆ·é¢æ¿ dashboard.php çš„é¡µé¢æ¨¡æ¿æ–‡ä»¶ -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>ä¸ªäººä¸»é¡µ</title>
    <link rel="stylesheet" href="css/dashboard.css">
    <!-- å¼•å…¥ UEditor -->
    <script type="text/javascript" src="../lib/ueditor/ueditor.config.js"></script>
    <script type="text/javascript" src="../lib/ueditor/ueditor.all.min.js"></script>
    <script type="text/javascript" src="../lib/ueditor/lang/zh-cn/zh-cn.js"></script>
    <script>UE.getEditor('gbook-editor');</script>
</head>
<body>
    <input type="hidden" id="csrf_token" value="{csrf_token}"><!-- è¿™ä¸ªéšè—å­—æ®µç”¨äºä¿å­˜token, ä¾¿äºåœ¨ JS ä¸­å–ç”¨ -->
    <div class="dashboard-box">

        <div id="profile-section">

            
            <div id="profile-left">
                <h2 id="username">{username}</h2>
                <div id="profile-left-bg">
                    <img src="{avatar}" alt="ç”¨æˆ·å¤´åƒ" id="avatarnow"><br>
                </div>
                <!-- ä¸ªç­¾ -->
                <div id="signature-display">
                    <p id="current-signature">{signature}</p>
                    <button id="edit-signature-btn">ç¼–è¾‘ç­¾å</button>
                    <button id="edit-infobg">ç¼–è¾‘å¤´å›¾</button>
                </div>
                <!-- é»˜è®¤éšè—ç¼–è¾‘åŒºåŸŸ -->
                <form id="signature-form" style="display: none;">
                    <textarea name="signature" rows="4" cols="30" id="signature-input">{signature}</textarea><br>
                    <button type="submit">ä¿å­˜ç­¾å</button>
                    <button type="button" id="cancel-edit-btn">å–æ¶ˆ</button>
                </form>
                <p id="signature-result" style="color: red;"></p>
            </div>


            <div id="profile-right">
                <!-- å†å²å¤´åƒæ ‡é¢˜å’Œæ›´æ–°æŒ‰é’® -->
                <div id="avatar-title">
                    <h3 id="avatar-h">å†å²å¤´åƒ</h>
                    <button id="show-avatar-upload-btn">æ›´æ–°å¤´åƒ</button>
                </div>
                <!-- æ‰€æœ‰å†å²å¤´åƒ -->
                <div id="avatar-gallery">{avatar_gallery}</div>
                <!-- å¤´åƒä¸Šä¼ åŒº: é»˜è®¤éšè—, æ˜¾ç¤ºæµ®åŠ¨ -->
                <div id="avatar-upload-div" style="display: none;">
                    <!-- å…³é—­æŒ‰é’® --> 
                    <span id="close-avatar-upload" 
                        style="position: absolute; top: 8px; right: 12px; 
                                cursor: pointer; font-size: 16px; color: #888;">
                        &times;
                    </span>
                    <p id="avatar-upload-p">æ›´æ–°å¤´åƒ</p>
                    <form enctype="multipart/form-data" id="avatar-upload-form" >
                        <input type="file" name="avatar" required id="avatar-input" onchange="updateFileName()">
                        <label for="avatar-input" class="custom-upload-button">é€‰æ‹©æ–‡ä»¶</label>
                        <span id="file-name">æœªé€‰æ‹©æ–‡ä»¶</span> <!-- ç”¨äºæ˜¾ç¤ºæ–‡ä»¶å -->
                        <button type="submit" id="avatar-upload-button">ä¸Šä¼ </button>
                    </form>
                    <p id="upload-result" style="color:red; font-size:10px;"></p><!-- å¦‚æœä¸Šä¼ äº†é”™è¯¯ç±»å‹æ–‡ä»¶,åˆ™æ˜¾ç¤ºçº¢è‰²æç¤º -->
                </div>
                <!-- ç…§ç‰‡æ ‡é¢˜+æŒ‰é’® -->
                <div id="photo-title">
                    <h3 id="photo-h">ç…§ç‰‡å¢™</h3>
                    <button id="show-photo-upload-btn">æ›´æ–°ç…§ç‰‡</button>
                </div> 
                <!-- æ‰€æœ‰ç…§ç‰‡å±•ç¤ºåŒº -->
                <div class="photo-gallery">{photo_gallery}</div>
                <!-- ç…§ç‰‡ä¸Šä¼ åŒºåŸŸ -->
                <div id="photo-upload-div" style="display: none;">
                    <!-- å…³é—­æŒ‰é’® --> 
                    <span id="close-photo-upload" 
                        style="position: absolute; top: 8px; right: 12px; 
                                cursor: pointer; font-size: 16px; color: #888;">
                        &times;
                    </span>
                    <p id="photo-upload-p">æ›´æ–°ç…§ç‰‡</p>
                    <form enctype="multipart/form-data" id="photo-upload-form">
                        <input type="file" name="photo" required id="photo-input">
                        <button type="submit" id="photo-upload-button">ä¸Šä¼ </button>
                    </form>
                    <p id="upload-photo-result" style="color:red; font-size:10px;"></p><!-- å¦‚æœä¸Šä¼ äº†é”™è¯¯ç±»å‹æ–‡ä»¶,åˆ™æ˜¾ç¤ºçº¢è‰²æç¤º -->
                </div>
            </div>
        </div>
        
        <div id="dashboard-link">
            <div class="link-buttons">
                <a href="gbook-board.php" class="gbook-link">ğŸŒ ä¸–ç•Œç•™è¨€æ¿</a>
                <a href="#" class="blog-link" id="show-blog-form">ğŸ“ å‘å¸ƒåšå®¢</a>
                <a href="logout.php" class="logout-link">ğŸšª é€€å‡ºç™»å½•</a>
            </div>

            <!-- åšå®¢å‘å¸ƒè¡¨å•ï¼šé»˜è®¤éšè— -->
            <form action="blog-add.php" method="post" id="blog-form" style="display: none; margin-top: 10px;">
                {csrf_input}
                <script id="gbook-editor" name="content" type="text/plain" style="width:100%;height:200px;"></script>
                <button type="submit" class="submit-button">å‘å¸ƒåšå®¢</button>
            </form>
        </div>
        
        <!--åšå®¢å†å²-->
        <div id="blog-list">
            <div class="blog-entries">{user_blogs}</div>
        </div>
        <br><br>
    </div>

    <script>
        // ç”¨äºåœ¨éšè—ä¸Šä¼ æ–‡ä»¶é»˜è®¤æ ¼å¼æ—¶æ˜¾ç¤ºé€‰æ‹©çš„æ–‡ä»¶å
        function updateFileName() {
            const input = document.getElementById('avatar-input');
            const fileName = document.getElementById('file-name');
            fileName.textContent = input.files.length > 0 ? input.files[0].name : 'æœªé€‰æ‹©æ–‡ä»¶'; // æ›´æ–°æ–‡ä»¶å
        }
        // å¼‚æ­¥ä¸Šä¼ å¤´åƒ
        document.getElementById('avatar-upload-form').addEventListener('submit', function(e) {
            e.preventDefault(); // é˜»æ­¢é»˜è®¤æäº¤è¡Œä¸º
            const formData = new FormData(this);
            // åŠ å…¥ CSRF Token(ä»htmlä¸­çš„éšè—å­—æ®µä¸­å–)
            formData.append('csrf_token', document.getElementById('csrf_token').value);
            fetch('avatar-upload.php', {
                method: 'POST',
                body: formData
            }).then(res => res.json())
            .then(result => {
                if (result.success) {
                    window.location.reload(); // æˆåŠŸååˆ·æ–°é¡µé¢
                } else {
                    // upload-result æ˜¯é”™è¯¯ä¿¡æ¯ HTML å…ƒç´ çš„ ID
                    document.getElementById('upload-result').textContent = result.error;
                }
            }).catch(() => {
                document.getElementById('upload-result').textContent = "ä¸Šä¼ å¤±è´¥ï¼Œè¯·ç¨åå†è¯•ã€‚";
            });
        });

        // å¼‚æ­¥ä¸Šä¼ ç…§ç‰‡
        document.getElementById('photo-upload-form').addEventListener('submit', function(e) {
            e.preventDefault(); // é˜»æ­¢é»˜è®¤æäº¤è¡Œä¸º
            const formData = new FormData(this);
            formData.append('csrf_token', document.getElementById('csrf_token').value);
            fetch('photo-upload.php', {
                method: 'POST',
                body: formData
            }).then(res => res.json())
            .then(result => {
                if (result.success) {
                    window.location.reload(); // æˆåŠŸååˆ·æ–°é¡µé¢
                } else {
                    // upload-result æ˜¯é”™è¯¯ä¿¡æ¯ HTML å…ƒç´ çš„ ID
                    document.getElementById('upload-photo-result').textContent = result.error;
                }
            }).catch(() => {
                document.getElementById('upload-photo-result').textContent = "ä¸Šä¼ å¤±è´¥ï¼Œè¯·ç¨åå†è¯•ã€‚";
            });
        });

        // ä¸ªæ€§ç­¾åçš„éšè—å’Œæ˜¾ç¤º
        document.getElementById('edit-signature-btn').addEventListener('click', function () {
            document.getElementById('signature-display').style.display = 'none';
            document.getElementById('signature-form').style.display = 'block';
        });
        document.getElementById('cancel-edit-btn').addEventListener('click', function () {
            document.getElementById('signature-form').style.display = 'none';
            document.getElementById('signature-display').style.display = 'block';
        });

        // å¼‚æ­¥æäº¤ç­¾åæ›´æ–°
        document.getElementById('signature-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            // åŠ å…¥ CSRF Token(ä»htmlä¸­çš„éšè—å­—æ®µä¸­å–)
            formData.append('csrf_token', document.getElementById('csrf_token').value);
            fetch('user-signature.php', {
                method: 'POST',
                body: formData
            }).then(res => res.json())
            .then(result => {
                if (result.success) {
                    window.location.reload(); // æˆåŠŸååˆ·æ–°é¡µé¢
                    //document.getElementById('signature-result').textContent = 'ç­¾åå·²æ›´æ–°';
                } else {
                    document.getElementById('signature-result').textContent = result.error;
                }
            }).catch(err => {
                document.getElementById('signature-result').textContent = 'æ›´æ–°å¤±è´¥ï¼Œè¯·ç¨åå†è¯•';
            });
        });

        // ä¸Šä¼ å¤´åƒè¡¨å•çš„éšè—å’Œæ˜¾ç¤º
        document.getElementById('show-avatar-upload-btn').addEventListener('click', function () {
            const uploadDiv = document.getElementById('avatar-upload-div');
            // å¦‚æœå½“å‰æ˜¯éšè—çš„ï¼Œåˆ™æ˜¾ç¤º
            if (uploadDiv.style.display === 'none') {
                uploadDiv.style.display = 'block';
            } else {
                uploadDiv.style.display = 'none';
            }
        });
        // ç‚¹å‡» Ã— æŒ‰é’®éšè—ä¸Šä¼ çª—å£
        document.getElementById('close-avatar-upload').addEventListener('click', function () {
            document.getElementById('avatar-upload-div').style.display = 'none';
        });

        // ä¸Šä¼ ç…§ç‰‡è¡¨å•çš„éšè—å’Œæ˜¾ç¤º
        document.getElementById('show-photo-upload-btn').addEventListener('click', function () {
            const uploadDiv = document.getElementById('photo-upload-div');
            // å¦‚æœå½“å‰æ˜¯éšè—çš„ï¼Œåˆ™æ˜¾ç¤º
            if (uploadDiv.style.display === 'none') {
                uploadDiv.style.display = 'block';
            } else {
                uploadDiv.style.display = 'none';
            }
        });
        // ç‚¹å‡» Ã— æŒ‰é’®éšè—ä¸Šä¼ çª—å£
        document.getElementById('close-photo-upload').addEventListener('click', function () {
            document.getElementById('photo-upload-div').style.display = 'none';
        });

        // åšå®¢ç¼–è¾‘åŒºåŸŸçš„éšè—å’Œæ˜¾ç¤º
        document.getElementById('show-blog-form').addEventListener('click', function(event) {
            event.preventDefault(); // é˜»æ­¢è·³è½¬
            const form = document.getElementById('blog-form');
            form.style.display = (form.style.display === 'none') ? 'block' : 'none';
        });

    </script>
</body>
</html>
