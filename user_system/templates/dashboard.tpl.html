<!-- 用户面板 dashboard.php 的页面模板文件 -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>个人主页</title>
    <link rel="stylesheet" href="css/dashboard.css">
</head>
<body>
    <input type="hidden" id="csrf_token" value="{csrf_token}"><!-- 这个隐藏字段用于保存token, 便于在 JS 中取用 -->
    <div class="dashboard-box">
        <div id="profile-section">
            <div id="profile-left">
                <h2 id="username">{username}</h2>
                <div id="profile-left-bg">
                    <img src="{avatar}" alt="用户头像" id="avatarnow"><br>
                </div>
                

                <!-- 个签 -->
                <div id="signature-display">
                    <p id="current-signature">{signature}</p>
                    <button id="edit-signature-btn">编辑签名</button>
                </div>
                <!-- 默认隐藏编辑区域 -->
                <form id="signature-form" style="display: none;">
                    <textarea name="signature" rows="3" cols="25" id="signature-input">{signature}</textarea><br>
                    <button type="submit">保存签名</button>
                    <button type="button" id="cancel-edit-btn">取消</button>
                </form>
                <p id="signature-result" style="color: red;"></p>
            </div>
            <div id="profile-right">
                <h3 id="avatar-h3">历史头像</h3>
                <!-- 历史头像 -->
                <div id="avatar-gallery">{avatar_gallery}</div>
                <!-- 头像上传 -->
                <div id="avatar-upload-div">
                    <!--<p id="avatar-upload-p">上传新头像</p>-->
                    <form enctype="multipart/form-data" id="avatar-upload-form" >
                        <input type="file" name="avatar" required id="avatar-input">
                        <button type="submit" id="avatar-upload-button">上传头像</button>
                    </form>
                    <p id="upload-result" style="color:red;"></p><!-- 如果上传了错误类型文件,则显示红色提示 -->
                </div>
                <!-- 精选照片上传 -->
                <h3 id="photo-h3">个人照片</h3>
                <!-- 精选照片展示 -->
                <div class="photo-gallery">{photo_gallery}</div>
                <!-- 照片上传 -->
                <div id="photo-upload-div">
                    <form action="photo-upload.php" method="post" enctype="multipart/form-data">
                        <input type="file" name="photo" required id="photo-input">
                        <input type="hidden" name="csrf_token" value="{csrf_token}">
                        <button type="submit" id="photo-upload-button">上传照片</button>
                    </form>
                </div>
            </div>
        </div>
        
        <hr>
        <a href="gbook-board.php">进入世界留言板</a><br>
        <a href="logout.php">退出登录</a>

        <hr>

        <!-- 用户博客发布 -->
        <h3>个人博客</h3>
        <!--博客发布区-->
        <div id="blog-editor-form">
            <button onclick="toggleBlogEditor()">添加新博客</button>
            <form action="blog-post.php" method="post">
                <input type="text" name="title" placeholder="标题" required><br>
                <textarea name="content" rows="5" cols="60" placeholder="内容" required></textarea><br>
                <input type="hidden" name="csrf_token" value="{csrf_token}">
                <button type="submit">发布</button>
            </form>
        </div>
        <!--博客历史-->
        <div id="blog-list">
            <h3>我的博客</h3>
            <div class="blog-entries">{user_blogs}</div>
        </div>
    </div>

    <!-- 异步 JS 上传 -->
    <script>
        // 异步上传头像
        document.getElementById('avatar-upload-form').addEventListener('submit', function(e) {
            e.preventDefault(); // 阻止默认提交行为
            const formData = new FormData(this);
            // 加入 CSRF Token(从html中的隐藏字段中取)
            formData.append('csrf_token', document.getElementById('csrf_token').value);
            fetch('avatar-upload.php', {
                method: 'POST',
                body: formData
            }).then(res => res.json())
            .then(result => {
                if (result.success) {
                    window.location.reload(); // 成功后刷新页面
                } else {
                    // upload-result 是错误信息 HTML 元素的 ID
                    document.getElementById('upload-result').textContent = result.error;
                }
            }).catch(() => {
                document.getElementById('upload-result').textContent = "上传失败，请稍后再试。";
            });
        });

        // 个性签名的展示/编辑模式切换逻辑
        document.getElementById('edit-signature-btn').addEventListener('click', function () {
            document.getElementById('signature-display').style.display = 'none';
            document.getElementById('signature-form').style.display = 'block';
        });
        document.getElementById('cancel-edit-btn').addEventListener('click', function () {
            document.getElementById('signature-form').style.display = 'none';
            document.getElementById('signature-display').style.display = 'block';
        });

        // 异步提交签名更新
        document.getElementById('signature-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            // 加入 CSRF Token(从html中的隐藏字段中取)
            formData.append('csrf_token', document.getElementById('csrf_token').value);
            fetch('user-signature.php', {
                method: 'POST',
                body: formData
            }).then(res => res.json())
            .then(result => {
                if (result.success) {
                    window.location.reload(); // 成功后刷新页面
                    //document.getElementById('signature-result').textContent = '签名已更新';
                } else {
                    document.getElementById('signature-result').textContent = result.error;
                }
            }).catch(err => {
                document.getElementById('signature-result').textContent = '更新失败，请稍后再试';
            });
        });

        // 博客编辑区域的隐藏和显示
        function toggleBlogEditor() {
            const editor = document.getElementById('blog-editor-form');
            editor.style.display = (editor.style.display === 'none' || editor.style.display === '') ? 'block' : 'none';
        }

    </script>
</body>
</html>
